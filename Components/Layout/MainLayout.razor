@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Web
@using WriterApp.Application.State
@implements IDisposable
@inject AppHeaderState HeaderState
@inject NavigationManager Navigation
@inject LayoutStateService LayoutStateService

<div class="app-shell @GetLayoutClass()">
    <header class="app-header">
        <div class="app-header-left">
            <a class="app-brand" href="">Writer</a>
        </div>
        <div class="app-header-center">
            <div class="app-breadcrumb">
                <NavLink class="app-breadcrumb-link" href="/documents" Match="NavLinkMatch.All">Documents</NavLink>
                @if (!string.IsNullOrWhiteSpace(HeaderState.DocumentTitle))
                {
                    <span class="app-breadcrumb-separator">â†’</span>
                    @if (_isEditingTitle && HeaderState.CanRenameDocumentTitle)
                    {
                        <input class="app-document-title-input"
                               value="@_documentTitleDraft"
                               @oninput="OnDocumentTitleInput"
                               @onblur="CommitTitleEdit"
                               @onkeydown="OnTitleKeyDown"
                               @ref="_titleInputRef"
                               aria-label="Rename document title"
                               onfocus="this.select()" />
                    }
                    else if (HeaderState.CanRenameDocumentTitle)
                    {
                        <button type="button" class="app-document-title-button" @onclick="StartTitleEdit">
                            <span class="app-document-title">@HeaderState.DocumentTitle</span>
                        </button>
                    }
                    else
                    {
                        <span class="app-document-title">@HeaderState.DocumentTitle</span>
                    }
                }
            </div>
        </div>
        <div class="app-header-right">
            <button type="button" class="app-link app-link-button" @onclick="OnAboutClicked">About</button>
        </div>
    </header>

    <main class="app-main">
        <div class="app-body">
            <nav class="app-nav">
                <NavLink class="app-nav-link" href="@GetEditorLink()" Match="NavLinkMatch.Prefix">Editor</NavLink>
                <NavLink class="app-nav-link" href="@GetSynopsisLink()" Match="NavLinkMatch.Prefix">Synopsis</NavLink>
                <NavLink class="app-nav-link" href="/documents" Match="NavLinkMatch.All">Documents</NavLink>
            </nav>
            <article class="content">
                @Body
            </article>
        </div>
    </main>
</div>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">??</span>
</div>

@code {
    protected override void OnInitialized()
    {
        HeaderState.OnChange += HandleHeaderChange;
        LayoutStateService.Changed += HandleLayoutStateChange;
    }

    public void Dispose()
    {
        HeaderState.OnChange -= HandleHeaderChange;
        LayoutStateService.Changed -= HandleLayoutStateChange;
    }

    private void HandleHeaderChange()
    {
        if (!HeaderState.CanRenameDocumentTitle)
        {
            _isEditingTitle = false;
        }

        InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_shouldFocusTitle && _isEditingTitle)
        {
            _shouldFocusTitle = false;
            await _titleInputRef.FocusAsync();
        }
    }

    private void HandleLayoutStateChange(LayoutState state)
    {
        InvokeAsync(StateHasChanged);
    }

    private void StartTitleEdit()
    {
        if (string.IsNullOrWhiteSpace(HeaderState.DocumentTitle) || !HeaderState.CanRenameDocumentTitle)
        {
            return;
        }

        _documentTitleDraft = HeaderState.DocumentTitle ?? string.Empty;
        _isEditingTitle = true;
        _shouldFocusTitle = true;
    }

    private void CommitTitleEdit()
    {
        if (!_isEditingTitle)
        {
            return;
        }

        string currentTitle = HeaderState.DocumentTitle ?? string.Empty;
        string nextTitle = (_documentTitleDraft ?? string.Empty).Trim();
        _isEditingTitle = false;

        if (string.IsNullOrWhiteSpace(nextTitle))
        {
            _documentTitleDraft = currentTitle;
            return;
        }

        if (string.Equals(currentTitle, nextTitle, StringComparison.Ordinal))
        {
            _documentTitleDraft = currentTitle;
            return;
        }

        HeaderState.RequestDocumentTitleEdit(nextTitle);
    }

    private void OnDocumentTitleInput(ChangeEventArgs args)
    {
        _documentTitleDraft = args.Value?.ToString() ?? string.Empty;
    }

    private void OnTitleKeyDown(KeyboardEventArgs args)
    {
        if (args.Key == "Enter")
        {
            CommitTitleEdit();
            return;
        }

        if (args.Key == "Escape")
        {
            _isEditingTitle = false;
            _documentTitleDraft = HeaderState.DocumentTitle ?? string.Empty;
        }
    }

    private string GetLayoutClass()
    {
        LayoutState state = LayoutStateService.State;
        return state.FocusMode || state.LeftNavCollapsed ? "is-focus-mode" : string.Empty;
    }

    private string GetEditorLink()
    {
        return string.IsNullOrWhiteSpace(HeaderState.DocumentId)
            ? "/documents"
            : $"/documents/{HeaderState.DocumentId}";
    }

    private string GetSynopsisLink()
    {
        return string.IsNullOrWhiteSpace(HeaderState.DocumentId)
            ? "/synopsis"
            : $"/synopsis/{HeaderState.DocumentId}";
    }

    private void OnAboutClicked()
    {
        Navigation.NavigateTo("https://learn.microsoft.com/aspnet/core/", forceLoad: true);
    }

    private bool _isEditingTitle;
    private bool _shouldFocusTitle;
    private string _documentTitleDraft = string.Empty;
    private ElementReference _titleInputRef;
}
