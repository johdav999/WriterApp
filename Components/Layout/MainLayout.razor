@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components.Authorization
@using WriterApp.Application.State
@implements IDisposable
@inject AppHeaderState HeaderState
@inject NavigationManager Navigation
@inject LayoutStateService LayoutStateService

<div class="app-shell @GetLayoutClass()">
    <header class="app-header">
        <div class="app-header-left">
            <a class="app-brand" href="">Writer</a>
            <NavLink class="app-link" href="" Match="NavLinkMatch.All">Documents</NavLink>
        </div>
        <div class="app-header-center">
            @if (!string.IsNullOrWhiteSpace(HeaderState.DocumentTitle))
            {
                <span class="app-document-title">@HeaderState.DocumentTitle</span>
            }
        </div>
        <div class="app-header-right">
            <button type="button" class="app-link app-link-button" @onclick="OnAboutClicked">About</button>
        </div>
    </header>

    <main class="app-main">
        <div class="app-body">
            <nav class="app-nav">
                <NavLink class="app-nav-link" href="@GetEditorLink()" Match="NavLinkMatch.Prefix">Editor</NavLink>
                <NavLink class="app-nav-link" href="@GetSynopsisLink()" Match="NavLinkMatch.Prefix">Synopsis</NavLink>
                <NavLink class="app-nav-link" href="" Match="NavLinkMatch.All">Documents</NavLink>
            </nav>
            <article class="content">
                @Body
            </article>
        </div>
    </main>
</div>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">??</span>
</div>

@code {
    protected override void OnInitialized()
    {
        HeaderState.OnChange += HandleHeaderChange;
        LayoutStateService.Changed += HandleLayoutStateChange;
    }

    public void Dispose()
    {
        HeaderState.OnChange -= HandleHeaderChange;
        LayoutStateService.Changed -= HandleLayoutStateChange;
    }

    private void HandleHeaderChange()
    {
        InvokeAsync(StateHasChanged);
    }

    private void HandleLayoutStateChange(LayoutState state)
    {
        InvokeAsync(StateHasChanged);
    }

    private string GetLayoutClass()
    {
        LayoutState state = LayoutStateService.State;
        return state.FocusMode || state.LeftNavCollapsed ? "is-focus-mode" : string.Empty;
    }

    private string GetEditorLink()
    {
        return string.IsNullOrWhiteSpace(HeaderState.DocumentId)
            ? "/doc"
            : $"/doc/{HeaderState.DocumentId}";
    }

    private string GetSynopsisLink()
    {
        return string.IsNullOrWhiteSpace(HeaderState.DocumentId)
            ? "/synopsis"
            : $"/synopsis/{HeaderState.DocumentId}";
    }

    private void OnAboutClicked()
    {
        Navigation.NavigateTo("https://learn.microsoft.com/aspnet/core/", forceLoad: true);
    }
}
