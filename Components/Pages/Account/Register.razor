@page "/account/register"
@using System.ComponentModel.DataAnnotations
@using System.Linq
@using Microsoft.AspNetCore.Identity
@using WriterApp.Data
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject NavigationManager Navigation

<PageTitle>Register</PageTitle>

<div class="auth-shell">
    <h1>Create account</h1>
    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <div class="auth-error">@_error</div>
    }
    <EditForm Model="_input" OnValidSubmit="HandleRegisterAsync">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <div class="auth-field">
            <label for="email">Email</label>
            <InputText id="email" class="form-control" @bind-Value="_input.Email" />
        </div>
        <div class="auth-field">
            <label for="password">Password</label>
            <InputText id="password" type="password" class="form-control" @bind-Value="_input.Password" />
        </div>
        <div class="auth-field">
            <label for="confirmPassword">Confirm password</label>
            <InputText id="confirmPassword" type="password" class="form-control" @bind-Value="_input.ConfirmPassword" />
        </div>
        <button type="submit" class="btn btn-primary">Create account</button>
    </EditForm>
    <div class="auth-footer">
        <a href="/account/login">Already have an account?</a>
    </div>
</div>

@code {
    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }

    private readonly RegisterInput _input = new();
    private string? _error;

    private async Task HandleRegisterAsync()
    {
        _error = null;

        var user = new ApplicationUser
        {
            UserName = _input.Email,
            Email = _input.Email,
            EmailConfirmed = true
        };

        IdentityResult result = await UserManager.CreateAsync(user, _input.Password);
        if (!result.Succeeded)
        {
            _error = string.Join(" ", result.Errors.Select(error => error.Description));
            return;
        }

        await SignInManager.SignInAsync(user, isPersistent: false);
        Navigation.NavigateTo(string.IsNullOrWhiteSpace(ReturnUrl) ? "/doc" : ReturnUrl, forceLoad: true);
    }

    private sealed class RegisterInput
    {
        [Required, EmailAddress]
        public string Email { get; set; } = string.Empty;

        [Required, MinLength(6)]
        public string Password { get; set; } = string.Empty;

        [Required, Compare(nameof(Password))]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
