@page "/admin/plan-assignments"
@rendermode Microsoft.AspNetCore.Components.Web.RenderMode.InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization
@using System.Security
@using System.Security.Claims
@using WriterApp.Application.Security
@using WriterApp.Application.Subscriptions
@using WriterApp.Data.Subscriptions
@attribute [Authorize(Policy = "AdminOnly")]
@inject AuthenticationStateProvider AuthStateProvider
@inject IPlanAssignmentService PlanAssignmentService
@inject IUserIdResolver UserIdResolver
@inject ILogger<PlanAssignments> Logger

<PageTitle>Admin - Plan Assignments</PageTitle>

<div class="admin-page">
    <h1>Assign plan to user</h1>

    @if (_isLoading)
    {
        <p>Loading plans...</p>
    }
    else
    {
        <div class="admin-form">
            <label for="adminUserId">User Id</label>
            <input id="adminUserId" type="text" @bind="_userIdInput" @bind:event="oninput" />

            <label for="adminPlanKey">Plan</label>
            <select id="adminPlanKey" @bind="_selectedPlanKey">
                @foreach (Plan plan in _plans)
                {
                    <option value="@plan.Key">@plan.Name (@plan.Key)</option>
                }
            </select>

            <div class="admin-form-actions">
                <button type="button" @onclick="OnAssignAsync" disabled="@(!_canAssign)">Assign</button>
                <button type="button" @onclick="OnLoadLatestAsync" disabled="@string.IsNullOrWhiteSpace(_userIdInput)">Load latest</button>
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(_statusMessage))
        {
            <p class="status-message">@_statusMessage</p>
        }

        @if (_latestAssignment is not null)
        {
            <div class="admin-latest">
                <h2>Latest assignment</h2>
                <p>User: @_latestAssignment.UserId</p>
                <p>Plan: @_latestAssignment.PlanName (@_latestAssignment.PlanKey)</p>
                <p>Assigned UTC: @_latestAssignment.AssignedUtc.ToString("u")</p>
            </div>
        }
    }
</div>

@code {
    private readonly List<Plan> _plans = new();
    private bool _isLoading = true;
    private string? _statusMessage;
    private string _userIdInput = string.Empty;
    private string _selectedPlanKey = string.Empty;
    private LatestAssignmentView? _latestAssignment;

    protected override async Task OnInitializedAsync()
    {
        await LoadPlansAsync();
    }

    private bool _canAssign => !string.IsNullOrWhiteSpace(_userIdInput) && !string.IsNullOrWhiteSpace(_selectedPlanKey);

    private async Task LoadPlansAsync()
    {
        _isLoading = true;
        _plans.Clear();
        _statusMessage = null;

        IReadOnlyList<Plan> plans = await PlanAssignmentService.GetActivePlansAsync();
        _plans.AddRange(plans);
        _selectedPlanKey = _plans.FirstOrDefault()?.Key ?? string.Empty;

        _isLoading = false;
    }

    private async Task OnAssignAsync()
    {
        _statusMessage = null;
        _latestAssignment = null;

        if (!_canAssign)
        {
            _statusMessage = "Provide a user id and choose a plan.";
            return;
        }

        try
        {
            AuthenticationState authState = await AuthStateProvider.GetAuthenticationStateAsync();
            ClaimsPrincipal user = authState.User;
            string? callerName = user.Identity?.Name;
            string assignedBy = ResolveAssignedBy(user, callerName);

            PlanAssignmentResult result = await PlanAssignmentService.AssignPlanAsync(
                _userIdInput,
                _selectedPlanKey,
                assignedBy,
                callerName,
                CancellationToken.None);

            _statusMessage = $"Assigned {result.UserId} to {result.PlanName}.";
            await LoadLatestAssignmentAsync(result.UserId);
        }
        catch (PlanAssignmentException ex)
        {
            _statusMessage = ex.Code switch
            {
                PlanAssignmentErrorCode.PlanNotFound => ex.Message,
                PlanAssignmentErrorCode.PlanInactive => ex.Message,
                PlanAssignmentErrorCode.InvalidUserId => ex.Message,
                PlanAssignmentErrorCode.InvalidPlanKey => ex.Message,
                PlanAssignmentErrorCode.AssignmentExists => ex.Message,
                _ => ex.Message
            };
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Admin assignment request failed.");
            _statusMessage = "Assignment request failed.";
        }
    }

    private async Task OnLoadLatestAsync()
    {
        _statusMessage = null;
        await LoadLatestAssignmentAsync(_userIdInput);
    }

    private async Task LoadLatestAssignmentAsync(string? userId)
    {
        if (string.IsNullOrWhiteSpace(userId))
        {
            _latestAssignment = null;
            return;
        }

        UserPlanAssignment? assignment = await PlanAssignmentService.GetLatestAssignmentAsync(userId);
        if (assignment?.Plan is null)
        {
            _latestAssignment = null;
            _statusMessage = "No assignments found for this user.";
            return;
        }

        _latestAssignment = new LatestAssignmentView(
            assignment.UserId,
            assignment.Plan.Key,
            assignment.Plan.Name,
            assignment.AssignedUtc);
    }

    private sealed record LatestAssignmentView(
        string UserId,
        string PlanKey,
        string PlanName,
        DateTime AssignedUtc);

    private string ResolveAssignedBy(ClaimsPrincipal user, string? callerName)
    {
        try
        {
            return UserIdResolver.ResolveUserId(user);
        }
        catch (SecurityException ex)
        {
            Logger.LogWarning(ex, "Admin assignment missing oid claim.");
            return callerName ?? "admin";
        }
    }
}
