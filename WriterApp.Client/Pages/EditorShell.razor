@inject HttpClient Http
@inject NavigationManager Nav

<PageTitle>Editor</PageTitle>

<h1>Editor (WASM)</h1>

@if (_loading)
{
    <p>Loading...</p>
}
else if (_error is not null)
{
    <p>@_error</p>
}
else if (_page is null)
{
    <p>Page not found.</p>
}
else
{
    <div class="editor-shell">
        <div class="editor-main">
            <textarea rows="16" style="width:100%;" @bind="_content"></textarea>
            <div>
                <button type="button" @onclick="SaveAsync">Save</button>
                @if (!string.IsNullOrWhiteSpace(_saveStatus))
                {
                    <span>@_saveStatus</span>
                }
            </div>
        </div>
        <ContextDrawer DocumentId="DocumentId"
                       SectionId="SectionId"
                       PageId="PageId"
                       PageContent="_content"
                       OnApplyProposal="ApplyProposalAsync" />
    </div>
}

@code {
    [Parameter] public Guid DocumentId { get; set; }
    [Parameter] public Guid SectionId { get; set; }
    [Parameter] public Guid PageId { get; set; }

    private PageDto? _page;
    private string _content = string.Empty;
    private bool _loading = true;
    private string? _error;
    private string? _saveStatus;

    protected override async Task OnParametersSetAsync()
    {
        await LoadPageAsync();
    }

    private async Task LoadPageAsync()
    {
        _loading = true;
        _error = null;

        try
        {
            List<PageDto>? pages = await Http.GetFromJsonAsync<List<PageDto>>($"api/sections/{SectionId}/pages");
            _page = pages?.FirstOrDefault(page => page.Id == PageId);
            if (_page is null && pages is { Count: > 0 })
            {
                PageDto first = pages[0];
                Nav.NavigateTo($"/documents/{DocumentId}/sections/{SectionId}/pages/{first.Id}", replace: true);
                return;
            }

            _content = _page?.Content ?? string.Empty;
        }
        catch (Exception ex)
        {
            _error = $"Load failed: {ex.Message}";
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task SaveAsync()
    {
        if (_page is null)
        {
            return;
        }

        _saveStatus = null;
        try
        {
            PageUpdateRequest payload = new(null, _content);
            using HttpResponseMessage response = await Http.PutAsJsonAsync($"api/pages/{_page.Id}", payload);
            response.EnsureSuccessStatusCode();
            PageDto? updated = await response.Content.ReadFromJsonAsync<PageDto>();
            if (updated is not null)
            {
                _page = updated;
                _content = updated.Content;
            }

            _saveStatus = "Saved.";
        }
        catch (Exception ex)
        {
            _saveStatus = $"Save failed: {ex.Message}";
        }
    }

    private async Task ApplyProposalAsync(string text)
    {
        _content = text;
        await SaveAsync();
    }
}
