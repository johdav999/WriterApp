@page "/synopsis"
@page "/synopsis/{DocumentId:guid}"
@using System.Net.Http.Json
@using WriterApp.Application.Documents
@inject HttpClient Http
@inject NavigationManager Navigation
@inject WriterApp.Client.State.CurrentDocumentStateService CurrentDocumentStateService
@inject ILogger<Synopsis> Logger

<PageTitle>Synopsis</PageTitle>

<div class="synopsis">
    <header class="synopsis-header">
        <div>
            <h1>Synopsis</h1>
            <p class="synopsis-subtitle">Capture the story outline for the current document.</p>
        </div>
        <button type="button" class="secondary" @onclick="NavigateToDocuments">Documents</button>
    </header>

    @if (DocumentId is null)
    {
        <div class="synopsis-empty">
            <div>No document selected. Choose a document to view or edit its synopsis.</div>
            <button type="button" class="primary" @onclick="NavigateToDocuments">Go to Documents</button>
        </div>
    }
    else if (_loading)
    {
        <div class="synopsis-loading">Loading synopsis...</div>
    }
    else if (!string.IsNullOrWhiteSpace(_error))
    {
        <div class="synopsis-error">@_error</div>
    }
    else
    {
        <div class="synopsis-editor">
            <textarea class="synopsis-input"
                      value="@_outlineDraft"
                      @oninput="OnOutlineInput"
                      placeholder="Write the synopsis for this document..."></textarea>
            <div class="synopsis-actions">
                <button type="button" class="primary" @onclick="OnSaveAsync" disabled="@_saving">
                    @(_saving ? "Saving..." : "Save synopsis")
                </button>
                @if (!string.IsNullOrWhiteSpace(_statusMessage))
                {
                    <span class="synopsis-status">@_statusMessage</span>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public Guid? DocumentId { get; set; }

    private Guid? _loadedDocumentId;
    private bool _loading;
    private bool _saving;
    private string _outlineDraft = string.Empty;
    private string? _error;
    private string? _statusMessage;

    protected override async Task OnParametersSetAsync()
    {
        if (DocumentId is null)
        {
            CurrentDocumentStateService.Clear();
            _loadedDocumentId = null;
            _outlineDraft = string.Empty;
            _error = null;
            _statusMessage = null;
            _loading = false;
            return;
        }

        CurrentDocumentStateService.SetDocument(DocumentId.Value);

        if (_loadedDocumentId != DocumentId)
        {
            await LoadSynopsisAsync(DocumentId.Value);
        }
    }

    private async Task LoadSynopsisAsync(Guid documentId)
    {
        _loading = true;
        _error = null;
        _statusMessage = null;

        try
        {
            DocumentOutlineDto? result =
                await Http.GetFromJsonAsync<DocumentOutlineDto>($"api/documents/{documentId}/outline");
            _outlineDraft = result?.Outline ?? string.Empty;
            _loadedDocumentId = documentId;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Synopsis load failed.");
            _error = "Failed to load the synopsis.";
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OnSaveAsync()
    {
        if (DocumentId is null || _saving)
        {
            return;
        }

        _saving = true;
        _statusMessage = null;

        try
        {
            DocumentOutlineDto payload = new(DocumentId.Value, _outlineDraft ?? string.Empty, DateTimeOffset.UtcNow);
            using HttpResponseMessage response =
                await Http.PutAsJsonAsync($"api/documents/{DocumentId}/outline", payload);
            response.EnsureSuccessStatusCode();
            _statusMessage = "Synopsis saved.";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Synopsis save failed.");
            _statusMessage = "Failed to save synopsis.";
        }
        finally
        {
            _saving = false;
        }
    }

    private void OnOutlineInput(ChangeEventArgs args)
    {
        _outlineDraft = args.Value?.ToString() ?? string.Empty;
        _statusMessage = null;
    }

    private void NavigateToDocuments()
    {
        Navigation.NavigateTo("documents");
    }
}
