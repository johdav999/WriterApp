@page "/documents/{DocumentId:guid}"
@using System.Net.Http.Json
@using WriterApp.Application.Documents
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>Opening document...</PageTitle>

@if (_loading)
{
    <div class="landing-loading">Loading document...</div>
}
else if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="landing-error">@_error</div>
    <button type="button" class="secondary" @onclick="GoToDocuments">Back to Documents</button>
}

@code {
    [Parameter]
    public Guid DocumentId { get; set; }

    private bool _loading = true;
    private string? _error;

    protected override async Task OnParametersSetAsync()
    {
        _loading = true;
        _error = null;

        try
        {
            List<SectionDto>? sections =
                await Http.GetFromJsonAsync<List<SectionDto>>($"api/documents/{DocumentId}/sections");
            SectionDto? first = sections?
                .OrderBy(section => section.OrderIndex)
                .FirstOrDefault();

            if (first is null)
            {
                _error = "No sections found for this document.";
                return;
            }

            Navigation.NavigateTo($"documents/{DocumentId}/sections/{first.Id}", replace: true);
        }
        catch (Exception ex)
        {
            _error = $"Open failed: {ex.Message}";
        }
        finally
        {
            _loading = false;
        }
    }

    private void GoToDocuments()
    {
        Navigation.NavigateTo("documents");
    }
}
