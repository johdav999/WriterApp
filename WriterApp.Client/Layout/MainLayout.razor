@inherits LayoutComponentBase
@using WriterApp.Client.State
@using System.Net.Http.Json
@using WriterApp.Application.Documents
@implements IDisposable
@inject LayoutStateService LayoutStateService
@inject CurrentDocumentStateService CurrentDocumentStateService
@inject LastOpenedDocumentStateService LastOpenedDocumentStateService
@inject HttpClient Http
@inject NavigationManager Navigation

<div class="app-shell @GetLayoutClass()">
    <header class="app-header">
        <div class="app-header-left">
            <a class="app-brand" href="">Writer</a>
        </div>
        <div class="app-header-center">
            <div class="app-breadcrumb">
                <NavLink class="app-breadcrumb-link" href="documents" Match="NavLinkMatch.Prefix">Documents</NavLink>
                @if (!string.IsNullOrWhiteSpace(_documentTitle))
                {
                    <span class="app-breadcrumb-separator">-&gt;</span>
                    <span class="app-document-title">@_documentTitle</span>
                }
            </div>
        </div>
        <div class="app-header-right">
            <button type="button" class="app-link app-link-button" @onclick="OnAboutClicked">About</button>
        </div>
    </header>

    <main class="app-main">
        <div class="app-body">
            <nav class="app-nav">
                @if (HasCurrentEditorLink)
                {
                    <NavLink class="app-nav-link" href="@GetEditorLink()" Match="NavLinkMatch.Prefix">Editor</NavLink>
                }
                else
                {
                    <a class="app-nav-link" href="documents">Editor</a>
                }
                @if (HasCurrentSynopsisLink)
                {
                    <NavLink class="app-nav-link" href="@GetSynopsisLink()" Match="NavLinkMatch.Prefix">Synopsis</NavLink>
                }
                else
                {
                    <a class="app-nav-link" href="documents">Synopsis</a>
                }
                <a class="app-nav-link @GetDocumentsActiveClass()"
                   href="documents"
                   @onclick="OnDocumentsNavClicked"
                   @onclick:preventDefault="true">Documents</a>
            </nav>
            <article class="content">
                @Body
            </article>
        </div>
    </main>
</div>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">×</span>
</div>

@code {
    protected override async Task OnInitializedAsync()
    {
        LayoutStateService.Changed += HandleLayoutStateChange;
        CurrentDocumentStateService.Changed += HandleDocumentStateChange;
        await LayoutStateService.InitializeAsync();
        await LastOpenedDocumentStateService.LoadAsync();
    }

    public void Dispose()
    {
        LayoutStateService.Changed -= HandleLayoutStateChange;
        CurrentDocumentStateService.Changed -= HandleDocumentStateChange;
    }

    private void HandleLayoutStateChange(LayoutState state)
    {
        InvokeAsync(StateHasChanged);
    }

    private void HandleDocumentStateChange()
    {
        _ = RefreshDocumentTitleAsync();
        InvokeAsync(StateHasChanged);
    }

    private string GetLayoutClass()
    {
        LayoutState state = LayoutStateService.State;
        return state.FocusMode || state.LeftNavCollapsed ? "is-focus-mode" : string.Empty;
    }

    private bool HasCurrentEditorLink =>
        CurrentDocumentStateService.DocumentId is Guid documentId &&
        CurrentDocumentStateService.SectionId is Guid sectionId &&
        documentId != Guid.Empty &&
        sectionId != Guid.Empty;

    private bool HasCurrentSynopsisLink =>
        CurrentDocumentStateService.DocumentId is Guid documentId &&
        documentId != Guid.Empty;

    private string GetDocumentsActiveClass()
    {
        return IsDocumentsRoute() ? "active" : string.Empty;
    }

    private string GetEditorLink()
    {
        if (!HasCurrentEditorLink)
        {
            return "documents";
        }

        Guid documentId = CurrentDocumentStateService.DocumentId!.Value;
        Guid sectionId = CurrentDocumentStateService.SectionId!.Value;
        return $"documents/{documentId}/sections/{sectionId}";
    }

    private string GetSynopsisLink()
    {
        if (!HasCurrentSynopsisLink)
        {
            return "documents";
        }

        Guid documentId = CurrentDocumentStateService.DocumentId!.Value;
        return $"synopsis/{documentId}";
    }

    private async Task RefreshDocumentTitleAsync()
    {
        Guid? documentId = CurrentDocumentStateService.DocumentId;
        if (documentId is null || documentId == Guid.Empty)
        {
            _documentTitle = string.Empty;
            _loadedDocumentId = null;
            return;
        }

        if (_loadedDocumentId == documentId)
        {
            return;
        }

        _loadedDocumentId = documentId;
        try
        {
            DocumentDetailDto? document =
                await Http.GetFromJsonAsync<DocumentDetailDto>($"api/documents/{documentId}");
            _documentTitle = document?.Title ?? "Untitled";
        }
        catch
        {
            _documentTitle = string.Empty;
        }
    }

    private async Task OnDocumentsNavClicked()
    {
        await NavigateDocumentsAsync();
    }

    private async Task NavigateDocumentsAsync()
    {
        await LastOpenedDocumentStateService.LoadAsync();

        if (IsDocumentsListRoute() && LastOpenedDocumentStateService.State is { } state)
        {
            (Guid? sectionId, bool shouldClear) = await TryResolveSectionAsync(state);
            if (sectionId is not null)
            {
                Navigation.NavigateTo($"documents/{state.DocumentId}/sections/{sectionId}");
                return;
            }

            if (shouldClear)
            {
                await LastOpenedDocumentStateService.ClearAsync();
            }
        }

        Navigation.NavigateTo("documents");
    }

    private async Task<(Guid? SectionId, bool ShouldClear)> TryResolveSectionAsync(LastOpenedDocumentState state)
    {
        try
        {
            using HttpResponseMessage response =
                await Http.GetAsync($"api/documents/{state.DocumentId}/sections");
            if (!response.IsSuccessStatusCode)
            {
                bool clear = response.StatusCode is System.Net.HttpStatusCode.NotFound
                    or System.Net.HttpStatusCode.Unauthorized;
                return (null, clear);
            }

            List<SectionDto>? sections = await response.Content.ReadFromJsonAsync<List<SectionDto>>();
            if (sections is null || sections.Count == 0)
            {
                return (null, true);
            }

            if (state.SectionId is Guid sectionId)
            {
                SectionDto? match = sections.FirstOrDefault(section => section.Id == sectionId);
                if (match is not null)
                {
                    return (match.Id, false);
                }
            }

            Guid? firstId = sections
                .OrderBy(section => section.OrderIndex)
                .FirstOrDefault()
                ?.Id;
            return (firstId, firstId is null);
        }
        catch
        {
            return (null, false);
        }
    }

    private bool IsDocumentsRoute()
    {
        string[] segments = GetRouteSegments();
        return segments.Length > 0 && string.Equals(segments[0], "documents", StringComparison.OrdinalIgnoreCase);
    }

    private bool IsDocumentsListRoute()
    {
        string[] segments = GetRouteSegments();
        return segments.Length == 1 && string.Equals(segments[0], "documents", StringComparison.OrdinalIgnoreCase);
    }

    private string[] GetRouteSegments()
    {
        string relative = Navigation.ToBaseRelativePath(Navigation.Uri);
        int queryStart = relative.IndexOfAny(['?', '#']);
        if (queryStart >= 0)
        {
            relative = relative[..queryStart];
        }

        return string.IsNullOrWhiteSpace(relative)
            ? Array.Empty<string>()
            : relative.Split('/', StringSplitOptions.RemoveEmptyEntries);
    }

    private void OnAboutClicked()
    {
        Navigation.NavigateTo("https://learn.microsoft.com/aspnet/core/", forceLoad: true);
    }

    private string _documentTitle = string.Empty;
    private Guid? _loadedDocumentId;
}
